(define-module (olscrbl main)
  :export (olscrbl-main))

(use-modules (ice-9 format)
             (ice-9 pretty-print)
             (olscrbl definitions)
             (olscrbl scrobbler-log)
             (olscrbl submit)
             (olscrbl config)
             (olscrbl config internal)
             (olscrbl config utils))

(define (olscrbl-main)
  (cond ((= (cnt-accounts) 0)
         (format #t "No accounts defined.\n")
         (quit 0)))
  (cond ((= (cnt-matchers) 0)
         (if (get-opt-unsafe 'note-default-matcher)
             (format #t "No matchers defined. Registering the default.\n"))
         (match-entry #:predicate (code #t))))
  (initialise-scrobbler-reader)
  #;(pretty-print (@@ (olscrbl reader) reader))
  #;(pretty-print (get-opt-unsafe 'log-file-type))
  (submit/setup-reader (get-opt-unsafe 'log-file-type))
  #;(submit/setup-threads accounts)
  (cond ((null? *program-args-non-options*)
         (submit-with-port (current-input-port)))
        (else
         (for-each (lambda (file)
                     (submit-with-file file))
                   *program-args-non-options*))))
